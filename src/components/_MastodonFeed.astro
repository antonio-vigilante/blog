---
// MastodonFeed.astro
// Componente per mostrare gli ultimi post da Mastodon
const instance = "poliversity.it";
const username = "naciketas";
const limit = 8; // Numero di post da mostrare
---

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400&display=swap" rel="stylesheet" />

<section class="mastodon-feed">
  <h2 class="text-2xl font-semibold tracking-wide">Da Mastodon</h2>
  <div id="mastodon-posts" class="posts-container">
    <div class="loading">Caricamento post...</div>
  </div>
  <div class="all-posts-btn-wrapper">
    <a 
      href={`https://${instance}/@${username}`} 
      target="_blank" 
      rel="noopener noreferrer"
      class="view-more"
    >
      Tutti i post su Mastodon
      <svg xmlns="http://www.w3.org/2000/svg" class="icon-tabler">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <path d="M9 6l6 6l-6 6"></path>
      </svg>
    </a>
  </div>
</section>

<style>
  .mastodon-feed {
    margin-bottom: 4rem;
    font-family: 'Roboto', sans-serif;
  }

  .posts-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
    margin-top: 1rem;
  }

  @media (max-width: 640px) {
    .posts-container {
      grid-template-columns: 1fr;
    }
  }

  .loading {
    text-align: center;
    color: var(--color-text-muted, #6b7280);
    padding: 2rem;
    font-style: italic;
  }

  .error {
    color: #ef4444;
    padding: 1rem;
    background: #fef2f2;
    border-radius: 0.375rem;
    text-align: center;
  }

  .mastodon-post {
    padding: 0;
    background: #f5f5f5;
    border-radius: 0.5rem;
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    flex-direction: column;
  }

  .mastodon-post:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
  }

  .post-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem 0.5rem;
  }

  .post-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex: 1;
    font-size: 0.875rem;
  }

  .post-author {
    font-weight: 500;
    color: var(--color-text-base, #1f2937);
    text-decoration: none;
  }

  .post-author:hover {
    text-decoration: underline;
  }

  .post-date {
    color: var(--color-text-muted, #6b7280);
  }

  .post-content {
    padding: 0 1rem 0.75rem;
    line-height: 1.75;
    color: var(--color-text-base, #1f2937);
    flex: 1;
  }

  .post-media {
    margin: 0;
    width: 100%;
    order: -1; /* immagine in cima alla card */
  }

  .post-image {
    width: 100%;
    height: 220px;
    object-fit: cover;
    display: block;
    border-radius: 0;
    transition: transform 0.3s;
  }

  .post-image:hover {
    transform: scale(1.03);
  }

  .post-content :global(p) {
    margin: 0.5em 0;
  }

  .post-content :global(a) {
    color: var(--color-accent, #2563eb);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .post-content :global(a:hover) {
    text-decoration: none;
  }

  .post-content :global(br) {
    display: block;
    content: "";
    margin: 0.5em 0;
  }

  .post-stats {
    display: flex;
    gap: 1rem;
    font-size: 0.875rem;
    color: var(--color-text-muted, #6b7280);
    margin-top: 0.5rem;
  }

  .stat {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }

  .all-posts-btn-wrapper {
    text-align: center;
  }

  .view-more {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text-base, #1f2937);
    text-decoration: none;
    text-decoration-color: transparent;
    padding: 0.5rem 1rem;
    transition: all 0.3s ease;
    border-radius: 0.375rem;
  }

  .view-more:hover {
    text-decoration-color: var(--color-text-base, #1f2937);
  }

  .icon-tabler {
    width: 1.25rem;
    height: 1.25rem;
    stroke-width: 2;
    stroke: currentColor;
    fill: none;
    stroke-linecap: round;
    stroke-linejoin: round;
  }

  @media (prefers-color-scheme: dark) {
    .mastodon-post {
      background: #1a1a1a;
    }
    .error {
      background: #7f1d1d;
      color: #fca5a5;
    }
  }

  @media (max-width: 768px) {
    .posts-container {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 480px) {
    .posts-container {
      grid-template-columns: 1fr;
    }
  }
</style>

<script define:vars={{ instance, username, limit }}>
  async function loadMastodonPosts() {
    const container = document.getElementById('mastodon-posts');
    
    try {
      const isPixelfed = instance.includes('pixelfed');
      
      let author, posts;

      if (isPixelfed) {
        const res = await fetch('/api/pixelfed');
        if (!res.ok) throw new Error('Errore nel caricamento');
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        author = data.author;
        posts = data.posts;
      } else {
        // Mastodon: chiamata diretta
        const accountRes = await fetch(
          `https://${instance}/api/v1/accounts/lookup?acct=${username}`
        );
        if (!accountRes.ok) throw new Error('Account non trovato');
        const account = await accountRes.json();
        author = account.display_name || account.username;

        const postsRes = await fetch(
          `https://${instance}/api/v1/accounts/${account.id}/statuses?limit=${limit}&exclude_replies=true&exclude_reblogs=true`
        );
        if (!postsRes.ok) throw new Error('Impossibile caricare i post');
        const rawPosts = await postsRes.json();

        // Normalizza formato Mastodon → formato comune
        posts = rawPosts.map((p) => ({
          id: p.id,
          url: p.url,
          published: p.created_at,
          content: (() => {
            const tmp = document.createElement('div');
            tmp.innerHTML = p.content;
            return (tmp.textContent || tmp.innerText || '').replace(/\s+/g, ' ').trim();
          })(),
          images: (p.media_attachments || [])
            .filter((m) => m.type === 'image')
            .map((m) => m.url),
        }));
      }

      if (!posts || posts.length === 0) {
        container.innerHTML = '<div class="error">Nessun post disponibile</div>';
        return;
      }

      container.innerHTML = '';

      posts.forEach((post) => {
        const article = document.createElement('article');
        article.className = 'mastodon-post';

        // Header con nome e data
        const header = document.createElement('div');
        header.className = 'post-header';
        const meta = document.createElement('div');
        meta.className = 'post-meta';

        const authorLink = document.createElement('a');
        authorLink.href = post.url;
        authorLink.target = '_blank';
        authorLink.rel = 'noopener noreferrer';
        authorLink.className = 'post-author';
        authorLink.textContent = author;

        const date = new Date(post.published);
        const dateSpan = document.createElement('span');
        dateSpan.className = 'post-date';
        dateSpan.textContent = '· ' + date.toLocaleDateString('it-IT', {
          day: 'numeric', month: 'short', year: 'numeric'
        });

        meta.appendChild(authorLink);
        meta.appendChild(dateSpan);
        header.appendChild(meta);

        // Testo del post (troncato se troppo lungo)
        const MAX_CHARS = 1000;
        const content = document.createElement('div');
        content.className = 'post-content';
        const temp = document.createElement('textarea');
        temp.innerHTML = post.content;
        const fullText = temp.value;
        content.textContent = fullText.length > MAX_CHARS
          ? fullText.slice(0, MAX_CHARS).trimEnd() + ' [...]'
          : fullText;

        // Immagine (se presente)
        let mediaContainer = null;
        if (post.images && post.images.length > 0) {
          mediaContainer = document.createElement('div');
          mediaContainer.className = 'post-media';
          const img = document.createElement('img');
          img.src = post.images[0];
          img.alt = post.content || 'Immagine del post';
          img.className = 'post-image';
          img.loading = 'lazy';
          mediaContainer.appendChild(img);
        }

        article.appendChild(header);
        if (mediaContainer) article.appendChild(mediaContainer);
        article.appendChild(content);
        container.appendChild(article);
      });

    } catch (error) {
      console.error('Errore:', error);
      container.innerHTML = `<div class="error">${error.message || 'Errore nel caricamento dei post.'}</div>`;
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadMastodonPosts);
  } else {
    loadMastodonPosts();
  }
</script>