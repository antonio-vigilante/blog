---
// MastodonFeed.astro
// Componente per mostrare gli ultimi post da Mastodon
const instance = "poliversity.it";
const username = "antoniovigilante";
const limit = 7; // Numero di post da mostrare
---

<section class="mastodon-feed">
  <h2 class="text-2xl font-semibold tracking-wide">Da Mastodon</h2>
  <div id="mastodon-posts" class="posts-container">
    <div class="loading">Caricamento post...</div>
  </div>
  <div class="all-posts-btn-wrapper">
    <a 
      href={`https://${instance}/@${username}`} 
      target="_blank" 
      rel="noopener noreferrer"
      class="view-more"
    >
      Tutti i post su Mastodon
      <svg xmlns="http://www.w3.org/2000/svg" class="icon-tabler">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <path d="M9 6l6 6l-6 6"></path>
      </svg>
    </a>
  </div>
</section>

<style>
  .mastodon-feed {
    margin-bottom: 4rem;
  }

  .posts-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 2rem;
    margin-top: 1rem;
  }

  .loading {
    text-align: center;
    color: var(--color-text-muted, #6b7280);
    padding: 2rem;
    font-style: italic;
  }

  .error {
    color: #ef4444;
    padding: 1rem;
    background: #fef2f2;
    border-radius: 0.375rem;
    text-align: center;
  }

  .mastodon-post {
    padding: 1rem;
    background: #f5f5f5;
    border-radius: 0.5rem;
    transition: transform 0.2s, background 0.2s;
  }

  .mastodon-post:hover {
    transform: translateX(4px);
    background: #eeeeee;
  }

  .post-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .post-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex: 1;
    font-size: 0.875rem;
  }

  .post-author {
    font-weight: 500;
    color: var(--color-text-base, #1f2937);
    text-decoration: none;
  }

  .post-author:hover {
    text-decoration: underline;
  }

  .post-date {
    color: var(--color-text-muted, #6b7280);
  }

  .post-content {
    margin-bottom: 0.75rem;
    line-height: 1.75;
    color: var(--color-text-base, #1f2937);
  }

  .post-media {
    margin: 1rem 0;
    display: grid;
    gap: 0.5rem;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  }

  .post-image {
    width: 100%;
    height: auto;
    border-radius: 0.5rem;
    object-fit: cover;
    max-height: 400px;
  }

  .post-content :global(p) {
    margin: 0.5em 0;
  }

  .post-content :global(a) {
    color: var(--color-accent, #2563eb);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .post-content :global(a:hover) {
    text-decoration: none;
  }

  .post-content :global(br) {
    display: block;
    content: "";
    margin: 0.5em 0;
  }

  .post-stats {
    display: flex;
    gap: 1rem;
    font-size: 0.875rem;
    color: var(--color-text-muted, #6b7280);
    margin-top: 0.5rem;
  }

  .stat {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }

  .all-posts-btn-wrapper {
    text-align: center;
  }

  .view-more {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text-base, #1f2937);
    text-decoration: none;
    text-decoration-color: transparent;
    padding: 0.5rem 1rem;
    transition: all 0.3s ease;
    border-radius: 0.375rem;
  }

  .view-more:hover {
    text-decoration-color: var(--color-text-base, #1f2937);
  }

  .icon-tabler {
    width: 1.25rem;
    height: 1.25rem;
    stroke-width: 2;
    stroke: currentColor;
    fill: none;
    stroke-linecap: round;
    stroke-linejoin: round;
  }

  @media (prefers-color-scheme: dark) {
    .mastodon-post {
      background: #1a1a1a;
    }

    .mastodon-post:hover {
      background: #222222;
    }

    .error {
      background: #7f1d1d;
      color: #fca5a5;
    }
  }
</style>

<script define:vars={{ instance, username, limit }}>
  async function loadMastodonPosts() {
    const container = document.getElementById('mastodon-posts');
    
    try {
      // Prima otteniamo l'ID dell'account
      const accountResponse = await fetch(
        `https://${instance}/api/v1/accounts/lookup?acct=${username}`
      );
      
      if (!accountResponse.ok) {
        throw new Error('Account non trovato');
      }
      
      const account = await accountResponse.json();
      
      // Poi recuperiamo i post dell'account
      const postsResponse = await fetch(
        `https://${instance}/api/v1/accounts/${account.id}/statuses?limit=${limit}&exclude_replies=true&exclude_reblogs=true`
      );
      
      if (!postsResponse.ok) {
        throw new Error('Impossibile caricare i post');
      }
      
      const posts = await postsResponse.json();
      
      if (posts.length === 0) {
        container.innerHTML = '<div class="error">Nessun post disponibile</div>';
        return;
      }
      
      // Creiamo un elemento per ogni post
      container.innerHTML = '';
      
      posts.forEach(post => {
        const date = new Date(post.created_at);
        const formattedDate = date.toLocaleDateString('it-IT', {
          day: 'numeric',
          month: 'short',
          year: 'numeric'
        });
        
        // Crea l'articolo
        const article = document.createElement('article');
        article.className = 'mastodon-post';
        
        // Header con meta (senza avatar)
        const header = document.createElement('div');
        header.className = 'post-header';
        
        const meta = document.createElement('div');
        meta.className = 'post-meta';
        
        const authorLink = document.createElement('a');
        authorLink.href = post.url;
        authorLink.target = '_blank';
        authorLink.rel = 'noopener noreferrer';
        authorLink.className = 'post-author';
        authorLink.textContent = account.display_name;
        
        const dateSpan = document.createElement('span');
        dateSpan.className = 'post-date';
        dateSpan.textContent = '¬∑ ' + formattedDate;
        
        meta.appendChild(authorLink);
        meta.appendChild(dateSpan);
        
        header.appendChild(meta);
        
        // Contenuto del post
        const content = document.createElement('div');
        content.className = 'post-content';
        content.innerHTML = post.content;
        
        // Immagini/media allegati
        let mediaContainer = null;
        if (post.media_attachments && post.media_attachments.length > 0) {
          mediaContainer = document.createElement('div');
          mediaContainer.className = 'post-media';
          
          post.media_attachments.forEach(media => {
            if (media.type === 'image') {
              const img = document.createElement('img');
              img.src = media.url;
              img.alt = media.description || 'Immagine del post';
              img.className = 'post-image';
              img.loading = 'lazy';
              mediaContainer.appendChild(img);
            }
          });
        }
        
        // Statistiche
        const stats = document.createElement('div');
        stats.className = 'post-stats';
        stats.innerHTML = `
          <span class="stat">üí¨ ${post.replies_count}</span>
          <span class="stat">üîÑ ${post.reblogs_count}</span>
          <span class="stat">‚≠ê ${post.favourites_count}</span>
        `;
        
        // Assembla tutto
        article.appendChild(header);
        article.appendChild(content);
        if (mediaContainer && mediaContainer.children.length > 0) {
          article.appendChild(mediaContainer);
        }
        article.appendChild(stats);
        
        container.appendChild(article);
      });
      
    } catch (error) {
      console.error('Errore nel caricamento dei post Mastodon:', error);
      container.innerHTML = '<div class="error">Errore nel caricamento dei post. Riprova pi√π tardi.</div>';
    }
  }
  
  // Carica i post quando il DOM √® pronto
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadMastodonPosts);
  } else {
    loadMastodonPosts();
  }
</script>
